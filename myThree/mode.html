<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<title>模型测试</title>
		<link rel="stylesheet" type="text/css" href="css/reset.css"/>
			<script src="js/three.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/OBJLoader.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/Detector.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/TrackballControls.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/UnpackDepthRGBAShader.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ShadowMapViewer.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/OrbitControls.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/stats.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/TGALoader.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<style type="text/css">
		.dList{
			position: relative;
			display: inline-block;
		}
		.dList dt{
			background-color: #C9C9C9;
			width: 200px;
			color: #ffffff;
			border-bottom: 1px solid #FFFFFF;
			font-size:14px;
			padding: 8px;
			text-align: center;
		}
		.dList dd{
			position: absolute;
			left: 200px;
			background-color: #D7D7D7;
			width: 350px;
			height: 300px;
			z-index: 2;
			padding-top: 13px;
			display: none;
			
		}
		img{
   			 width: 78px;
   			 height: 78px;
		}
		.Img_logo{
			width: 31.3%;
			display: inline-block;
		    text-align: center;
		    cursor: pointer;
		    padding: 5px 0px;
		}
		.Img_logo:hover{
			background-color: #C9C9C9;
		}
		.itemImg{
	    	padding: 0px 0px;
		}
		.ShowPanel{
		    width: 70%;
		    height: 560px;
		    display: inline-block;
		    background-color: #D7D7D7;
		    float: left;
		}
	</style>
	<body>
		<div style="float: left;">
			<dl class="dList">
			<dt class="d1">鞋的大底</dt>
			<dd class="dd1" >
				<div class="Item">
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[5],'img/tt.jpg')">
						<div class="itemImg"><img src="img/tt.jpg"/></div>
						<span class="itemCont">粉色皮质</span>
					</div>
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[5],'img/ttr.jpg')">
						<div class="itemImg"><img src="img/ttr.jpg"/></div>
						<span class="itemCont">褐色皮质</span>
					</div>
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[5],'img/ttblack.jpg')">
						<div class="itemImg"><img src="img/ttblack.jpg"/></div>
						<span class="itemCont">黑色皮质</span>
					</div>
					
				</div>
			</dd>
			<dt class="d2">鞋的装饰</dt>
			<dd class="dd2">
				<div class="Item">
					<div class="Img_logo" onclick="addObj()">
						<div class="itemImg"><img src="img/flower.jpg"/></div>
						<span class="itemCont">花装饰</span>
					</div>
					
					
				</div>
				
			</dd>
			<dt class="d3">鞋的鞋面</dt>
			<dd class="dd3">
				<div class="Item">
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[0],'img/tt.jpg')">
						<div class="itemImg"><img src="img/tt.jpg"/></div>
						<span class="itemCont">粉色皮质</span>
					</div>
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[0],'img/ttr.jpg')">
						<div class="itemImg"><img src="img/ttr.jpg"/></div>
						<span class="itemCont">褐色皮质</span>
					</div>
					<div class="Img_logo" onclick="editObjMaterial(Meshstorage[0],'img/ttblack.jpg')">
						<div class="itemImg"><img src="img/ttblack.jpg"/></div>
						<span class="itemCont">黑色皮质</span>
					</div>
					
				</div>
				
			</dd>
			<!--<dt class="d4">鞋子部件</dt>
			<dd class="dd4">
				<div class="Item">
					<div class="Img_logo">
						<div class="itemImg"><img src="img/tt.jpg"/></div>
						<span class="itemCont">粉色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttr.jpg"/></div>
						<span class="itemCont">褐色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttblack.jpg"/></div>
						<span class="itemCont">黑色皮质</span>
					</div>
					
				</div>
				
			</dd>
			<dt class="d5">鞋子部件</dt>
			<dd class="dd5">
				<div class="Item">
					<div class="Img_logo">
						<div class="itemImg"><img src="img/tt.jpg"/></div>
						<span class="itemCont">粉色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttr.jpg"/></div>
						<span class="itemCont">褐色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttblack.jpg"/></div>
						<span class="itemCont">黑色皮质</span>
					</div>
				</div>
			</dd>-->
			<!--<dt class="d6">颜色</dt>
			<dd class="dd6">
				<div class="Item">
					<div class="Img_logo">
						<div class="itemImg"><img src="img/tt.jpg"/></div>
						<span class="itemCont">粉色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttr.jpg"/></div>
						<span class="itemCont">褐色皮质</span>
					</div>
					<div class="Img_logo">
						<div class="itemImg"><img src="img/ttblack.jpg"/></div>
						<span class="itemCont">黑色皮质</span>
					</div>
					
				</div>
			</dd>-->
			<dt class="d7">尺寸</dt>
			<dd class="dd7"></dd>
			<dt class="d8">3DOE脚型数据推荐脚型码数</dt>
			<dd class="dd8"></dd>
		</dl>
		
		</div>
		<div id="ShowPanel" class="ShowPanel"></div>
	
	</body>
	<script type="text/javascript">
		"use strict";
		let dtList = document.getElementsByTagName('dt');
		let ddList = document.getElementsByTagName('dd');
		let dtDocument = [];
		let num = null;
		for(let i in dtList){
			if(i.length<=1){
				let dtElement = {};
				dtElement.top = ~~((~~(i))*(dtList[i].clientHeight+1));
				dtElement.dt = dtList[i];
				dtElement.name = dtList[i].className;
				dtList[i].addEventListener('mouseenter',dtMove);
				dtList[i].addEventListener('mouseleave',dtLeave);
				dtDocument.push(dtElement);
			}
		
		}
		function getIndex(a,b){
			for(let i in a){
				if(a[i].name == b){
					 return i;
				}
			}
		}
		function dtMove(e){
			e.target.style.backgroundColor = '#A1A1A1';
			let index = getIndex(dtDocument,e.target.className);
			ddList[index].style.display = 'block';
		}
		function dtLeave(e){
			e.target.style.backgroundColor = '#cccccc';
			let index = getIndex(dtDocument,e.target.className);
			ddList[index].style.display = 'none';
			
		}
		function ddMove(e){
			e.target.style.display = 'block';
		}
		function ddLeave(e){
			e.target.style.display = 'none';
		}
		function dd(){
			for(let i in ddList){
				if(i.length<=1){
					ddList[i].style.top = dtDocument[i].top+'px';
					ddList[i].addEventListener('mouseenter',ddMove);
					ddList[i].addEventListener('mouseleave',ddLeave);
				}
		  }
		}
		dd();
	</script>
	<!--微调渲染机制-->
	<script type="xme-shader/x-fragnt" id="fragmentShader">
		uniform vec3 topColor;
		uniform vec3 bottomColor;
		uniform float offset;
		uniform float exponent;
		varying vec3 vWorldPosition;
		void main() {
			float h = normalize( vWorldPosition + offset ).y;
			gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );
		}
	</script>	
	<script type="x-shader/x-vertex" id="vertexShader">
		varying vec3 vWorldPosition;
		void main() {
			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}
	</script>

	
	
	
	<script type="text/javascript">
		
		"use strict";
		let c = null;
		let cur,index,cIndex=0;
		var scene = new THREE.Scene(),
			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000), renderer;
		var spotLight;
		var tx = 600;
		var object3D = new THREE.Object3D();
		var controls;
		var objList = {};
		var container = document.createElement('div'),ts = document.getElementById('ShowPanel'),
			body = document.body;
		var loader = new THREE.OBJLoader();
		var btn = document.getElementById('change_btn'),btn1= document.getElementById('change_bu'),btn2= document.getElementById('change_del'),sel1=document.getElementById('shoes'),sel2=document.getElementById('shoesColor');
		var Meshstorage = {};
		var mouse = new THREE.Vector2();
		var raycaster,INTERSECTED;
		var r;
		var loadImg = ['model/shiKe/chanFang.obj'];
//		var loadImg = ['model/combine1.obj','model/fillet14.obj','model/fillet13.obj','model/loft1.obj','model/sweep2.obj','model/sweep3.obj','model/thicken15.obj'];
		var lightHelper,shadowCameraHelper;
		
//		var objSet = new objLoad();
		init();
		animate();

		function init() {
			//镜头设置
			
			camera.position.y = 50;
			camera.position.z = 10;
			
			//灯光设置、以及投影设置
			
			//环境光
//			scene.add( new THREE.AmbientLight( 0xe4e4e4 ,1.05) );
			scene.add( new THREE.AmbientLight( 0xe4e4e4 ,1.05) );

		    spotLight = new THREE.SpotLight( 0xffffff );
			spotLight.name = 'Spot Light';
//			spotLight.angle = Math.PI / 5;
			spotLight.penumbra = 0.3;
			spotLight.position.set( 0, 500, 0 );
			spotLight.castShadow = true;
			spotLight.distance = 0;
			spotLight.shadow.camera.near = 10;
			spotLight.shadow.camera.far =600;
			spotLight.shadow.mapSize.width = 4096;
			spotLight.shadow.mapSize.height = 4096;
			scene.add( spotLight );
//			scene.add( new THREE.CameraHelper( spotLight.shadow.camera ) );
			
			
			
			

//			辅助线设置
//			 lightHelper = new THREE.SpotLightHelper( spotLight );
//			scene.add( lightHelper );
//			 shadowCameraHelper = new THREE.CameraHelper( spotLight.shadow.camera );
//			scene.add( shadowCameraHelper );

			
			
			
			
			//地板设置
			var texture =textureLoad('img/r.jpg');
			var material =  new THREE.MeshPhongMaterial({
//				map: texture,
				specular: 0x111111, 
				shininess: 50,
//				color:0xffffff,
				dithering: true 
			});
			var geometry = new THREE.BoxGeometry(1000, 1,1000 );
			var mesh = new THREE.Mesh( geometry, material );
			mesh.position.set( 0, - 1, 0 );
			mesh.receiveShadow = true;
			scene.add( mesh );
			
			
		
			
			//调用obj加载方法
//			objLoad(loadImg,'img/floor.png');
		
			
			//射线定位，鼠标放在某个组件的时候触发该事件
//			raycaster = new THREE.Raycaster();
			
			
			
			//渲染机制
			renderer = new THREE.WebGLRenderer();
			renderer.setClearColor(0xffffff,1);
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.gammaInput = true;
			renderer.gammaOutput = true;

			/***
			 *视角插件 
			 *maxPolarAngle 最大视角角度
			 *autoRotate    是否旋转
			 *noZoom        是否放大
			 * 
			 */
		    controls = new THREE.OrbitControls( camera, renderer.domElement );
			controls.addEventListener( 'change', render ); 
			controls.maxPolarAngle = $deg(60);
			controls.autoRotate=false;
			// enable animation loop when using damping or autorotation
//			controls.enableDamping = true;
//			controls.dampingFactor = 0.25;
//			controls.noZoom = true;
			
			window.addEventListener( 'resize', onWindowResize, false );
			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			container.appendChild(renderer.domElement);
			ts.appendChild(container);
		}
		//窗口发生改变的时候
		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize( window.innerWidth, window.innerHeight );
		
		}
		function animate() {
			requestAnimationFrame(animate);
			controls.update();
			render();
		}
		function onDocumentMouseMove(event){
			console.log('event',event);
			event.preventDefault();
			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
		}
		
		
		function $deg(deg){
			return (Math.PI/180)*deg;
		}
		function render() {
			//辅助线更新
//			lightHelper.update();
//			shadowCameraHelper.update();
			//射线定位方法个体
//			raycaster.setFromCamera( mouse, camera );
//			var intersects = raycaster.intersectObjects( scene.children[scene.children.length-1].children);
////			选中
//			if ( intersects.length > 0 ) {
//
//					if ( INTERSECTED != intersects[ 0 ].object ) {
//
//						if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
//						INTERSECTED = intersects[ 0 ].object;
//						INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
//						INTERSECTED.material.emissive.setHex( 0xff00ff );
//
//					}
//
//				} else {
//
//					if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
//
//					INTERSECTED = null;
//
//				}

			//渲染重置
			renderer.render(scene, camera);
		}
		function objLoad(url, tmaterial) {
			if(url==null && tmaterial==null){
				return ;
			}
			for(let  t = 0;t<url.length;t++){
						loader.load(
						// 资源链接
							url[t],
							// 资源加载完成后的回调函数
							function(object) {
									object.traverse(function(child) {
										if(child instanceof THREE.Mesh) {
											// child.material.map = texture;
											var texture =textureLoad(tmaterial);
											var material =  new THREE.MeshPhongMaterial({
												map: texture,
												specular: 0x111111, 
												shininess: 50
											});
											child.material = material;
											child.castShadow  = true;
											child.receiveShadow   = false;
											child.position.y = 0;
											child.position.x = -120;
											child.rotation.set($deg(90), 0, $deg(90));
											Meshstorage[t] = child;
											if(url[t]=='model/fillet14.obj'){
												c = child;
											}else{
												
												object3D.add(child);
												scene.add(object3D);
											}

											
										}
									});
									

									spotLightResetAndCameraZReset(Meshstorage);
							}
						);
						
						
				
			}
			
			
		}
		
		objLoad.prototype.objModelAllLoad = function(url,mat){
			loader.load(
						// 资源链接
							url,
							// 资源加载完成后的回调函数
							function(object) {
									object.traverse(function(child) {
										if(child instanceof THREE.Mesh) {
											var texture =textureLoad(mat);
											var material =  new THREE.MeshPhongMaterial({
												map: texture,
												specular: 0x111111, 
												shininess: 50
											});
											child.material = material;
											child.castShadow  = true;
											child.receiveShadow   = false;
											
										}
									});
									
									//一个模型中有多个组件
									for(var i=0;i< object.children.length;i++){
										Meshstorage[i]=object.children[i];
									}
									for(var i in Meshstorage){
										if(Meshstorage[i].name == 'Box04'|| Meshstorage[i].name == 'Plane05'){
											object3D.add(Meshstorage[i]);
										}
									}
									console.log(object3D);
									console.log(Meshstorage);
									scene.add(object3D);
									spotLightResetAndCameraZReset(Meshstorage);
							}
						);
		};
//		
//		objLoad.prototype.objModelAllLoadt = function(url,mat){
//			loader.load(
//						// 资源链接
//							url,
//							// 资源加载完成后的回调函数
//							function(object) {
//									var loader = new THREE.TGALoader();
//									var texture1 = loader.load( 'model/texture/Map__1_Speckle.tga' );
//									var material =  new THREE.MeshPhongMaterial({
//										map: texture1,
//										color:0xffffff
//									});
//									for(var i of object.children){
//										console.log(i);
//										i.material =material;
//									}
//									scene.add(object);
//							}
//						);
//		};


		var a = new objLoad();
		a.objModelAllLoad("model/shiKe/chanFang2.obj",'img/ttblack.jpg');
		//增加模型(暂时)
		function addObj(){
			
			editObjMaterial(Meshstorage[1],'img/jewel/gold.jpg');
			editObjMaterial(Meshstorage[2],'img/jewel/orange.jpg');
			editObjMaterial(Meshstorage[3],'img/jewel/pink.jpg');
			editObjMaterial(Meshstorage[4],'img/jewel/yellow.jpg');
			object3D.add(Meshstorage[1]);
			object3D.add(Meshstorage[2]);
			object3D.add(Meshstorage[3]);
			object3D.add(Meshstorage[4]);
		}
		//去除模型
		function removeObj(mesh){
			return object3D.remove(mesh);
		}
		//材质加载
		function textureLoad(url){
			return new THREE.TextureLoader().load(url);
		}
		//修改模型
		function editObjMaterial(mesh,imgUrl){
			var texture = textureLoad(imgUrl);
			var material2 =  new THREE.MeshPhongMaterial({
				map: texture, 
				specular: 0x111111, 
				shininess: 50
			});
			mesh.material =material2;
		}
		//顶光重设,影子投影修改
		function spotLightResetAndCameraZReset(mesh){
			var maxObjY = getObjMaxYLocation(mesh);
			if(maxObjY>140){
				spotLight.shadow.mapSize.width = 1024;
				spotLight.shadow.mapSize.height = 1024;
			}else{
				spotLight.shadow.mapSize.width = 4096;
				spotLight.shadow.mapSize.height = 4096;
			}
			camera.position.z = maxObjY*10>500?500:maxObjY*10;
			camera.position.y = maxObjY*5>500?400:maxObjY*5;
		}
		//获取obj最高的模型的顶点坐标
		function getObjMaxYLocation(mesh){
			var c = ObjToArr(mesh);
			return Math.max.apply(null ,c);
		}
		//重新计算的obj模型的顶点坐标，并且更新获取
		function ObjToArr(obj){
			var arr = new Array();
			for(var i in obj){
				obj[i].geometry.computeBoundingSphere();
				var t = obj[i].geometry.clone();
				arr.push(Math.abs(~~(t.boundingSphere.center.y)));
			}
			return arr;
		}
	</script>
</html>
